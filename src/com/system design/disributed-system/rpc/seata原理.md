## 阿里分布式事务框架Seata原理解析

Seata框架是一个业务层的XA(两阶段提交)解决方案

### MySQL XA方案

+ RM(Resource Manager) ：用于直接执行本地事务的提交和回滚。在分布式集群中，一台MySQL服务器就是一个RM
+ TM(Transaction Manager) ：TM是分布式事务的核心管理器。事务管理器与每个RM进行通信，协调并完成分布式事务的处理。发起一个分布式事务的MySQL客户端就是一个TM

XA的两阶段提交分为Prepare阶段和Commit阶段：

1. 准备(prepare)阶段。即所有的RM锁住需要的资源，在本地执行这个事务(执行sql，写redo/undo log等)，但不提交，然后向TM报告已准备就绪
2. 提交(commit)阶段。当TM确认所有参与者都ready后，向所有参与者发送commit命令。

![XA](pic\XA.PNG)

#### XA方案存在的问题

1. TM单点问题
2. 数据库性能问题，XA过程中长时间占用资源(加锁)直到提交完成才释放
3. 第二阶段时若部分参与者因宕机提交失败，造成数据不一致(一般使用脚本进行检查，人工补偿)

### MySQL 3PC方案

3PC的三阶段提交分为CanCommit、PreCommit、DoCommit 三个阶段：

1. CanCommit阶段。尝试获取数据库锁
2. PreCommit阶段。协调者与参与者都引入超时机制(2PC中只有协调者可以超时)
3. DoCommit阶段。提交事务

#### 2PC与3PC对比

+ 协调者与参与者都引入超时机制，避免协调者宕机的情况下，无法释放资源的问题，从而降低整个事务的阻塞时间和范围
+ 多了CanCommit，降低事务失败的机率

### Seata方案（1 ID   3 组件）

Seata的分布式事务解决方案是业务层面的解决方案，只依赖于单台数据库的事务能力。

+ TC(Transaction Coordinator) ：事务协调器，维护全局事务的运行状态，负责协调并驱动全局事务的提交或回滚。
+ RM(Resource Manager) ：控制分支事务，负责分支注册、状态汇报，并接收事务协调器的指令，驱动分支事务的提交和回滚
+ TM(Transaction Manager) ：控制全局事务的边界，负责开启一个全局事务，并最终发起全局提交或全局回滚的决议

![seata](pic\seata.PNG)

分布式事务在Seata中的执行流程：

1. TM向TC申请开启一个全局事务，全局事务创建成功并生成一个全局唯一的XID
2. XID在微服务调用链路的上下文中传播
3. RM向TC注册分支事务，接着执行这个分支事务**并提交**，最后将执行结果汇报给TC
4. TM根据TC中所有分支事务的执行情况，发起全局提交或回滚决议
5. TC调度XID下管辖的全部分支事务完成提交或回滚请求

#### 为什么Seata在第一阶段就直接提交了分支事务

Seata能够在第一阶段直接提交事务，是因为Seata框架为每一个RM维护了一张UNDO_LOG表，其中保存了每一次本地事务的回滚数据。因此，二阶段的回滚并不依赖于本地数据库事务的回滚，而是RM直接读取这张UNDO_LOG表，并将数据库中的数据更新为历史数据

如果第二阶段是提交命令，RM事实上并不会对数据进行提交，而是发起一个异步请求删除UNDO_LOG中关于本事务的记录

#### Seata隔离机制

**全局事务的隔离性是建立在分支事务的本地隔离级别基础之上的**

在数据库本地隔离级别**读已提交**或以上的前提下，Seata设计了由事务协调器维护的**全局写排他锁**，来保证事务间的**写隔离**，将全局事务默认定义在**读未提交**的隔离级别上

即，全局事务未提交，但本地已提交的数据，对其他全局事务是可见的，但其他全局事务不能操作该数据，必须等当前全局事务提交

#### Seata支持的模式

+ AT模式：业务逻辑不需要关注事务机制，分支与全局事务的交互过程自动进行

  ![AT](pic\AT.png)

+ MT模式：业务逻辑需要被分解为 Prepare/Commit/Rollback 3 部分，形成一个MT分支，加入全局事务

  ![MT](pic\MT.png)

#### XA和Seata AT的对比

![XA和Seata](pic\XA和Seata.PNG)

XA方案的RM实际上是在数据库层，RM本质上就是数据库自身。而Seata的RM是以二方包的形式作为中间件层部署在应用程序侧，不依赖与数据库本身对协议的支持，当然也不需要数据库支持XA协议。

XA方案无论Phase2的决议是commit还是rollback，事务性资源的锁都要保持到Phase2完成才能释放。而对于Seata，将锁分为了本地锁和全局锁，本地锁由本地事务管理，在分支事务Phase1结束时就直接释放。而全局锁由TC管理，在决议Phase2全局提交时，可以释放。

![XA锁资源](pic\XA锁资源.PNG)

![Seata锁资源](pic\Seata锁资源.PNG)