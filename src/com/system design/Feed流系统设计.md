## Feed 流系统

Q:微博关注流如何设计？

### 简介

Feed本意是饲料，Feed流本意是有人一直在一个地方投递新鲜的饲料，如果需要饲料，只需要盯着投递点就可以，这样就能源源不断获取到新鲜的饲料。在信息学中，Feed其实是一个信息单元，比如一条朋友圈状态、一条微博等，所以Feed流就是不停更新的信息单元。当前最流行的Feed流产品有微博、微信朋友圈、头条、快手推荐等。

### Feed流系统特点

Feed流本质上是一个数据流，将N个发布者的信息单元通过关注关系传送给M个接收者。从数据层面看可划分为三种：

1. 发布者的数据-存储表(永久保存)
2. 关注关系-关注表(永久保存)
3. 接收者的数据-同步库(存储接收者的时间热度数据，只需要保留最近一段时间的数据)

### Feed流系统设计

1. 存储

   存储的特征就是数据可靠、不丢失、易于水平扩展  ==> 分布式NoSQL数据库 or MySql集群模式

2. 数据同步

   + 推模式(写扩散)

     发布者发送了一条消息后，立即将这个消息推送给接收者，但接收者此时不一定在线，那么就需要有一个地方存储这个数据(同步库)。这个模式下，对同步库的要求就是写入能力极强和稳定。

   + 拉模式(读扩散)

     发布者发送了一条消息后，不会立即推送给粉丝，而是写入自己的发件箱，当粉丝上线后再去自己关注者的发件箱里面去读取，一条消息的写入只有一次，但是读取最多回合粉丝数一样，读会放大，所以也叫读扩散。对系统的要求就是读取能力强。

     缺点：每个粉丝需要记录自己上次读到了关注者的哪条消息，如果有1000个关注者，那么就需要记录1000个位置，和关注量成正比，远比用户数大

   + 推拉结合

     推模式在单向关系中，因为存在大V，那么一条消息可能会扩散几百万次，但是这些用户中可能有一半多是僵尸，永远不会上线，那么就存在资源浪费。而拉模式，在系统架构上会比较复杂，同时需要记录消息读取的位置。基于此有了推拉模式，大部分用户的消息都是写扩散，只有大V是读扩散，这样既控制了资源浪费，又减少了系统设计复杂度